<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Groceries</title>

    <script>
        function main() {
            window.deptPro = document.getElementById("deptProto");
            window.prodPro = document.getElementById("prodProto");
            window.inputTable = document.getElementById("input");

            inputTable.tFoot.addEventListener("click", addDepartment, false);

            let deptInit = new Event("click");
            inputTable.tFoot.dispatchEvent(deptInit);

            fetchData();
        }

        function addDepartment(ev) {
            ev.stopPropagation();
            ev.preventDefault();

            let newDept = document.createElement("tbody");
            inputTable.insertBefore(newDept, ev.currentTarget);

            //  DEPARTMENT ROW
            let deptRow = newDept.insertRow(-1);
            deptRow.className = "department";

            let deptDelCell = deptRow.insertCell(-1);
            let deptDelLabel = deptDelCell.appendChild(document.createElement("span"));
            deptDelLabel.textContent = "(-)";
            deptDelLabel.addEventListener("click", deleteDepartment, false);

            let deptCell = deptRow.insertCell(-1);
            deptCell.colSpan = 8;

            let deptLabel = deptCell.appendChild(document.createElement("span"));
            deptLabel.textContent = "DEPARTMENT";
            deptLabel.contentEditable = true;

            //  ADD ROW
            let addRow = newDept.insertRow(-1);
            addRow.className = "add";
            addRow.addEventListener("click", addProduct, false);

            let addCell = addRow.insertCell(-1);
            addCell.colSpan = 9;

            let addLabel = addCell.appendChild(document.createElement("span"));
            addLabel.textContent = "ADD PRODUCT";

            let prodInit = new Event("click");
            addRow.dispatchEvent(prodInit);
        }
        function addProduct(ev) {
            ev.stopPropagation();
            ev.preventDefault();

            let newProd = document.createElement("tr");
            let parent = ev.currentTarget.parentElement;
            parent.insertBefore(newProd, ev.currentTarget);

            let delCell = newProd.insertCell(-1);
            let delLabel = delCell.appendChild(document.createElement("span"));
            delLabel.textContent = "(-)";
            delLabel.addEventListener("click", deleteProduct, false);

            let skuCell = newProd.insertCell(-1);
            let skuLabel = skuCell.appendChild(document.createElement("span"));
            skuLabel.textContent = "SKU";
            skuLabel.contentEditable = true;
            skuLabel.addEventListener("focus", selectInput, false);
            skuLabel.addEventListener("blur", populateIfEmpty.bind(skuLabel, "SKU"), false);

            let descCell = newProd.insertCell(-1);
            let descLabel = descCell.appendChild(document.createElement("span"));
            descLabel.textContent = "DESCRIPTION";
            descLabel.contentEditable = true;
            descLabel.addEventListener("focus", selectInput, false);
            descLabel.addEventListener("blur", populateIfEmpty.bind(descLabel, "DESCRIPTION"), false);

            let qtyCell = newProd.insertCell(-1);
            let qtyLabel = qtyCell.appendChild(document.createElement("span"));
            qtyLabel.textContent = "QTY";
            qtyLabel.contentEditable = true;
            qtyLabel.addEventListener("focus", selectInput, false);
            qtyLabel.addEventListener("blur", populateIfEmpty.bind(qtyLabel, "QTY"), false);

            let unitCell = newProd.insertCell(-1);
            let unitLabel = unitCell.appendChild(document.createElement("span"));
            unitLabel.textContent = "UNIT";
            unitLabel.contentEditable = true;
            unitLabel.addEventListener("focus", selectInput, false);
            unitLabel.addEventListener("blur", populateIfEmpty.bind(unitLabel, "UNIT"), false);

            let priceCell = newProd.insertCell(-1);
            let priceLabel = priceCell.appendChild(document.createElement("span"));
            priceLabel.textContent = "PRICE";
            priceLabel.contentEditable = true;
            priceLabel.addEventListener("focus", selectInput, false);
            priceLabel.addEventListener("blur", populateIfEmpty.bind(priceLabel, "PRICE"), false);

            let codeCell = newProd.insertCell(-1);
            let codeLabel = codeCell.appendChild(document.createElement("span"));
            codeLabel.textContent = "CODE";
            codeLabel.contentEditable = true;
            codeLabel.addEventListener("focus", selectInput, false);
            codeLabel.addEventListener("blur", populateIfEmpty.bind(codeLabel, "CODE"), false);

            let taxCell = newProd.insertCell(-1);
            let taxLabel = taxCell.appendChild(document.createElement("span"));
            taxLabel.textContent = "TAXED";
            taxLabel.contentEditable = true;
            taxLabel.addEventListener("focus", selectInput, false);
            taxLabel.addEventListener("blur", populateIfEmpty.bind(taxLabel, "TAXED"), false);

            let discCell = newProd.insertCell(-1);
            let discLabel = discCell.appendChild(document.createElement("span"));
            discLabel.textContent = "DISCOUNT";
            discLabel.contentEditable = true;
            discLabel.addEventListener("focus", selectInput, false);
            discLabel.addEventListener("blur", populateIfEmpty.bind(discLabel, "DISCOUNT"), false);
        }

        function selectInput(ev) {
            let range = document.createRange();
            range.selectNodeContents(ev.target);
            let sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
        function populateIfEmpty(val, ev) {
            if(this.textContent === "") {
                this.textContent = val;
            }
        }
        function checkSKUIndex() {
            let sku = Number(this.textContent);
            // if skuIndex
        }

        function deleteDepartment(ev) {
            let dept = ev.target.parentElement.parentElement.parentElement;
            if(confirm("Delete " + dept.rows[0].cells[1].children[0].textContent + "?")) {
                inputTable.removeChild(dept);
            }
        }
        function deleteProduct(ev) {
            let prod = ev.target.parentElement.parentElement;
            let tbody = prod.parentElement;
            if(confirm("Delete " + prod.cells[2].children[0].textContent + "?")) {
                tbody.removeChild(prod);
            }
        }

        function fetchData() {
            let request = new XMLHttpRequest();
            request.onreadystatechange = function() {
                if(this.readyState === 4 && this.statusText === "OK") {
                    populateHistory(parseXML(this.responseXML));
                }
            };

            let now = new Date(0);
            request.open("GET", "data.xml");
            request.setRequestHeader("If-Modified-Since", now.toUTCString());
            request.send();
        }
        function parseXML(doc) {
            //  Create a data structure to populate history table
            let purchases = [];

            //  Create index of SKU's to be used for auto-fill
            //  SKU's are parsed into an index by using their string representation as an index
            //  When matching input, this index will have to be looped and all possible matches pushed too an array
            //  This array should then be sorted by frequency, and the SKU with the most occurrences should be suggested first
            //  If multiple SKUs match the pattern and have equal number of occurrences, there should be no preference for one or the other
            window.skuIndex = {};

            let lists = doc.getElementsByTagName("purchase");
            for (let purcEl of lists) {
                let purc = {
                    date: purcEl.getElementsByTagName("date")[0].textContent,
                    time: purcEl.getElementsByTagName("time")[0].textContent,
                    location: purcEl.getElementsByTagName("location")[0].textContent,
                    account: purcEl.getElementsByTagName("account")[0].textContent,
                    total: 0,
                    departments: []
                };
                purchases.push(purc);

                let departments = purcEl.getElementsByTagName("department");
                for(let deptEl of departments) {
                    let dept = {
                        name: deptEl.getAttribute("name"),
                        products: []
                    };
                    purc.departments.push(dept);

                    let products = deptEl.getElementsByTagName("product");
                    for(let prodEl of products) {
                        let prod = {
                            sku: prodEl.getElementsByTagName("sku")[0].textContent,
                            desc: prodEl.getElementsByTagName("description")[0].textContent,
                            qty: prodEl.getElementsByTagName("quantity")[0].textContent,
                            unit: prodEl.getElementsByTagName("unit")[0].textContent,
                            price: prodEl.getElementsByTagName("price")[0].textContent,
                            code: prodEl.getElementsByTagName("code")[0].textContent,
                            tax: prodEl.getElementsByTagName("taxed")[0].textContent,
                            disc: prodEl.getElementsByTagName("discount")[0].textContent,
                        };
                        dept.products.push(prod);
                        //  There could potentially be some optimization for memory done here to avoid creating redundant objects for a single SKU, but it may well be worth waiting to see if a single SKU's product description price, etc. remain constant in the long term. Even if a product's price changes over time, a different approach would be necessary for this optimization.

                        if(!skuIndex[prod.sku]) {
                            skuIndex[prod.sku] = prod;
                            prod.count = 1;
                        }
                        else {
                            skuIndex[prod.sku].count++;
                        }
                        //  Notice that the skuIndex only keeps track of the first object defined for a given SKU. If the same SKU appears again in a subsequent purchase, the purchases entry will refer to a new object instantiated for the second appearance though the skuIndex will maintain reference only to the first index, and its count will be incremented. The counts are in fact the reason for this apparent inconsistency -- defining the count on each instance would be self-defeating as each instance would have count of 1. As noted above, there is likely some optimization to be realized here, but that is left for a later date.
                    }
                }
            }

            //  Return a data structure to populate history table
            purchases.sort((a, b)=>b.date-a.date);
            return purchases;
        }
        function populateHistory(data) {
            //  Show a table with summary data for each purchase, with ability to expand each one to show all details
        }

        function saveList() {
            let str = getXMLString().replace(/&/g, "#amp#").replace("$", "&dollar;");

            let httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = function() {
                if(httpRequest.readyState === XMLHttpRequest.DONE) {
                    if(httpRequest.statusText === "OK") {
                        let text = httpRequest.responseText;
                        let bytes = Number(text);
                        if(!Number.isNaN(bytes)) {
                            console.log(`${str.length} string characters -> ${bytes} bytes`);
                            alert(`List recorded successfully`);
                            clearInput();

                            // finance.display.log.addTransaction(txn);
                        }
                        else if(text === "false") {
                            alert(`Error recording the list: 'fail' response received from server`);
                        }
                        else {
                            alert(`Error recording the list: unrecognized response received from server:\n${text}`);
                        }
                    }
                    else {
                        alert(`Error recording the list: XMLHttpRequest status code: ${httpRequest.status}`);
                    }
                }
            };
            httpRequest.open("POST", "saveList.php");
            httpRequest.setRequestHeader("content-type", "application/x-www-form-urlencoded");
            httpRequest.send(`xmlStr=${str}`);
        }
        function getXMLString() {
            let xmlString = `<purchase>\n`;

            let date = document.getElementById("date").value;
            xmlString += `<date>${date}</date>\n`;

            let time = document.getElementById("time").value;
            xmlString += `<time>${time}</time>\n`;

            let location = document.getElementById("location").value;
            xmlString += `<location>${location}</location>\n`;

            let account = document.getElementById("account").value;
            xmlString += `<account>${account}</account>\n`;

            for(let dept of inputTable.tBodies) {
                let name = dept.rows[0].cells[1].children[0].textContent;
                xmlString += `<department name="${name}">\n`;

                for(let prod of dept.rows) {
                    if(prod.className === "department" || prod.className === "add") {
                        continue;
                    }
                    xmlString += `<product>\n`;

                    let sku = prod.cells[1].children[0].textContent;
                    xmlString += `<sku>${sku}</sku>\n`;

                    let desc = prod.cells[2].children[0].textContent;
                    xmlString += `<description>${desc}</description>\n`;

                    let qty = prod.cells[3].children[0].textContent;
                    xmlString += `<quantity>${qty}</quantity>\n`;

                    let unit = prod.cells[4].children[0].textContent;
                    xmlString += `<unit>${unit}</unit>\n`;

                    let price = prod.cells[5].children[0].textContent;
                    xmlString += `<price>${price}</price>\n`;

                    let code = prod.cells[6].children[0].textContent;
                    xmlString += `<code>${code}</code>\n`;

                    let tax = prod.cells[7].children[0].textContent;
                    xmlString += `<taxed>${tax}</taxed>\n`;

                    let disc = prod.cells[8].children[0].textContent;
                    xmlString += `<discount>${disc}</discount>\n`;

                    xmlString += `</product>\n`;
                }

                xmlString += `</department>\n`;
            }

            xmlString += `</purchase>\n`;

            return xmlString;
        }

        function clearInput() {
            for(let dept of inputTable.tBodies) {
                inputTable.removeChild(dept);
            }

            let deptReset = new Event("click");
            inputTable.tFoot.dispatchEvent(deptReset);
        }
    </script>

    <style type="text/css">
        *
        {
            user-select: none;
        }
        span
        {
            cursor: pointer;
        }
        span[contenteditable]
        {
            cursor: auto;
        }
        #input
        {
            border: 2px solid black;
            border-collapse: collapse;
        }
        #input td
        {
            border: 1px solid black;
        }
        th:first-child
        {
            text-align: left;
        }
    </style>

</head>
<body onload="main()">

<!--

PURCHASE
- DATE/TIME
- LOCATION/STORE
- TOTAL COST & PAYMENT METHOD

DEPARTMENT
- NAME

PRODUCT
- SKU
- DESCRIPTION
- QTY
- UNIT
- PRICE
- CODE/TAXED
- DISCOUNT

-->

<input type="button" value="Save" onclick="saveList()" />

<table id="input">
    <thead>
        <tr>
            <th colspan="2"><input id="date" title="date" type="date" /></th>
            <th><input id="time" title="time" type="time" /></th>
            <th colspan="5"><input id="location" type="text" placeholder="LOCATION" /></th>
            <th><input id="account" type="text" placeholder="ACCOUNT" /></th>
        </tr>
    </thead>
    <tfoot>
        <tr class="add">
            <td colspan="9"><span>ADD DEPARTMENT</span></td>
        </tr>
    </tfoot>
</table>

<input type="button" value="Save" onclick="saveList()" />

</body>
</html>